<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dikotik Dinleme Izmir</title>
</head>
<body>
<h1>Dikotik Dinleme Izmir</h1>

<div id="participantCard">
  <input id="name" placeholder="Ad">
  <input id="surname" placeholder="Soyad">
  <input id="email" placeholder="E-posta (opsiyonel)">
  <button id="makeCodeBtn">Katılımcı Kodunu Oluştur</button>
  <div id="codeInfo"></div>
</div>

<div id="hearingCard" style="display:none">
  <p>İşitme bilgileri ekranı...</p>
  <button id="toEnd">Devam Et</button>
</div>

<div id="endCard" style="display:none">
  <p>Deney tamamlandı ✅</p>
  <button id="downloadBtn">CSV İndir</button>
  <button id="emailBtn">E-posta Gönder</button>
  <div id="doneLog"></div>
</div>

<div class="card">
  <div class="label">Log</div>
  <div id="log">Henüz kayıt yok.</div>
</div>

<script>
let participant = {};
let results = [];

// Playlist array (Playlist-2.txt içinden alındı)
const playlist = [
  "LBA-RKA.wav","LDA-RGA.wav","LPA-RBA.wav","LKA-RDA.wav","LBA-RBA.wav",
  "LTA-RGA.wav","LBA-RDA.wav","LGA-RPA.wav","LDA-RKA.wav","LPA-RTA.wav",
  "LKA-RKA.wav","LBA-RGA.wav","LKA-RPA.wav","LTA-RDA.wav","LGA-RKA.wav",
  "LPA-RDA.wav","LGA-RGA.wav","LBA-RTA.wav","LGA-RDA.wav","LKA-RTA.wav",
  "LDA-RPA.wav","LTA-RKA.wav","LPA-RPA.wav","LDA-RBA.wav","LGA-RTA.wav",
  "LPA-RKA.wav","LTA-RBA.wav","LDA-RTA.wav","LTA-RPA.wav","LKA-RGA.wav",
  "LGA-RBA.wav","LKA-RBA.wav","LTA-RTA.wav","LGA-RLA.wav","LDA-RLA.wav",
  "LKA-RLA.wav"
];

// Log helper
function log(msg){
  const el = document.getElementById('log');
  el.innerHTML += "<br>" + msg;
}

// Katılımcı kodu üretme
function makeParticipantCode(){
  const name = (document.getElementById('name').value||'').trim();
  const surname = (document.getElementById('surname').value||'').trim();
  const n2 = (name.padEnd(2).slice(0,2)).toUpperCase();
  const s2 = (surname.padEnd(2).slice(0,2)).toUpperCase();
  const four = (n2+s2).replace(/[^A-Z]/g,'X').slice(0,4);
  const rand5 = Math.floor(10000+Math.random()*90000);
  const code = four+'_'+String(rand5);
  participant.code = code;
  participant.four = four;
  participant.rand5 = rand5;
  document.getElementById('codeInfo').innerText = "Katılımcı kodu: "+code;
  log("Katılımcı kodu oluşturuldu: "+code);
  return code;
}

document.getElementById('makeCodeBtn').addEventListener('click', ()=>{ 
  const code = makeParticipantCode(); 
  alert("Katılımcı kodunuz: "+code); 
  document.getElementById('participantCard').style.display='none'; 
  document.getElementById('hearingCard').style.display='block'; 
});

document.getElementById('toEnd').addEventListener('click', ()=>{
  // playlist'ten örnek yanıt ekleme
  results.push({trial:1, stim:playlist[0], response:"BA"});
  document.getElementById('hearingCard').style.display='none';
  document.getElementById('endCard').style.display='block';
  log("Deney tamamlandı, sonuç kaydedildi.");
});

// CSV indirme
document.getElementById('downloadBtn').addEventListener('click', ()=>{
  if(results.length===0){alert("Henüz sonuç yok");return;}
  const keys=Object.keys(results[0]);
  const header=keys.join(',');
  const rows=results.map(r=>keys.map(k=>String(r[k]??'')).join(','));
  const csv=[header,...rows].join('\\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=participant.code+"_results.csv";a.click();
  URL.revokeObjectURL(url);
  log("CSV indirildi.");
});

// EmailJS gönderimi
document.getElementById('emailBtn').addEventListener('click', async ()=>{
  if(results.length===0){alert("Henüz sonuç yok");return;}
  const keys=Object.keys(results[0]);
  const header=keys.join(',');
  const rows=results.map(r=>keys.map(k=>String(r[k]??'')).join(','));
  const csv=[header,...rows].join('\\n');

  // Senin index-3.html dosyanda zaten doldurduğun değerler olmalı
  const EMAILJS_USER    = "FLn2zMqKDGso3ePoO";
  const EMAILJS_SERVICE = "service_a8bnfmk";
  const EMAILJS_TEMPLATE= "template_7elc4wi";

  if(EMAILJS_USER.startsWith("YOUR_")){
    alert("E-posta için EmailJS bilgilerini doldurun.");
    return;
  }

  try {
    if(!window.emailjs){
      await new Promise((res,rej)=>{
        const s=document.createElement("script");
        s.src="https://cdn.emailjs.com/dist/email.min.js";
        s.onload=res; s.onerror=rej;
        document.head.appendChild(s);
      });
    }
    emailjs.init(EMAILJS_USER);
    const toAddress = document.getElementById('email').value||"";
    const templateParams = {
      to_email: toAddress,
      subject: participant.code||"",
      message: csv
    };
    const resp = await emailjs.send(EMAILJS_SERVICE,EMAILJS_TEMPLATE,templateParams);
    alert("E-posta gönderildi ✅");
    document.getElementById('doneLog').innerText="EmailJS cevabı: "+JSON.stringify(resp);
    log("E-posta gönderildi: "+JSON.stringify(resp));
  }catch(err){
    alert("E-posta gönderilemedi: "+err);
    log("E-posta hatası: "+err);
  }
});
</script>

</body>
</html>
