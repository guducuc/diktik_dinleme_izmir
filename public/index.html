<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dikotik Dinleme Izmir</title>

  <meta name="emailjs-user"    content="FLn2zMqKDGso3ePoO">
  <meta name="emailjs-service" content="service_a8bnfmk">
  <meta name="emailjs-template"content="template_7elc4wi">

  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:12px;color:#111}
    h1{font-size:20px;margin-bottom:8px}
    .hidden{display:none}
    .card{padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:12px}
    input,select{padding:8px;margin:6px 0;width:100% ;box-sizing:border-box}
    .respRow{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .respBtn{
      font-size:2rem;
      padding:18px 26px;
      margin:6px;
      min-width:120px;
      border-radius:10px;
      border:1px solid #444;
      background:#f2f2f2;
      cursor:pointer;
    }
    #warning{color:#8b0000;font-weight:600}
    .small{font-size:13px;color:#666}
  </style>
</head>
<body>
  <h1>Dikotik Dinleme Izmir</h1>

  <div id="participantCard" class="card">
    <div><input id="name" placeholder="Ad"></div>
    <div><input id="surname" placeholder="Soyad"></div>
    <div><input id="age" type="number" placeholder="Yaş"></div>
    <div><input id="race" placeholder="Irk"></div>
    <div><input id="motherTongue" placeholder="Anadil"></div>
    <div>
      <select id="gender">
        <option value="">Cinsiyet seçin</option>
        <option value="Kadın">Kadın</option>
        <option value="Erkek">Erkek</option>
        <option value="Diğer">Diğer</option>
      </select>
    </div>
    <div><input id="email" placeholder="E-posta (opsiyonel)"></div>
    <div style="margin-top:8px"><button id="makeCodeBtn">Katılımcı Kodunu Oluştur</button></div>
    <div id="codeInfo" class="small" style="margin-top:8px"></div>
  </div>

  <div id="hearingCard" class="card hidden">
    <h3>İşitme Kontrolü</h3>
    <p class="small">Aşağıdaki slider ile 1500 Hz tonunu her iki kulağınız için ayarlayın. "Oynat" butonuna basarak sesi kontrol edin.</p>

    <div style="margin-top:8px">
      <div><strong>Sağ kulak (1500 Hz)</strong></div>
      <input type="range" id="rightSlider" min="0" max="1" step="0.01" value="0.5">
      <button id="playRight" style="margin-top:6px">Oynat / Durdur</button>
    </div>

    <div style="margin-top:12px">
      <div><strong>Sol kulak (1500 Hz)</strong></div>
      <input type="range" id="leftSlider" min="0" max="1" step="0.01" value="0.5">
      <button id="playLeft" style="margin-top:6px">Oynat / Durdur</button>
    </div>

    <div style="margin-top:12px">
      <button id="toSessionIntro">Devam</button>
    </div>
  </div>

  <div id="sessionIntro" class="card hidden">
    <h3 id="sessionTitle"></h3>
    <p id="sessionInstr"></p>
    <div style="margin-top:10px"><button id="sessionStartBtn">Devam</button></div>
  </div>

  <div id="waitScreen" class="card hidden">
    <h3>Test şimdi başlıyor...</h3>
    <p class="small">Lütfen kulaklıklarınızı yerinde tutun. Test 10 saniye sonra başlayacak.</p>
  </div>

  <div id="trialCard" class="card hidden">
    <div id="trialStatus" class="small" style="margin-bottom:8px"></div>
    <audio id="stimAudio" controls style="display:none" preload="auto"></audio>
    <div class="respRow">
      <button class="respBtn" data-val="BA">BA</button>
      <button class="respBtn" data-val="DA">DA</button>
      <button class="respBtn" data-val="GA">GA</button>
      <button class="respBtn" data-val="KA">KA</button>
      <button class="respBtn" data-val="PA">PA</button>
      <button class="respBtn" data-val="TA">TA</button>
    </div>
  </div>

  <div id="endCard" class="card hidden">
    <h3>Deney tamamlandı ✅</h3>
    <div style="margin-top:8px">
      <button id="downloadBtn">CSV İndir</button>
      <button id="emailBtn">E-posta Gönder</button>
    </div>
    <div id="doneLog" class="small" style="margin-top:8px"></div>
  </div>

<script>
/* ================== CONFIG (EmailJS: meta or global fallback) ================== */
const CONFIG = {
  EMAILJS_USER: (document.querySelector('meta[name="emailjs-user"]')?.content) || window.EMAILJS_USER || window.__EMAILJS_USER__ || 'YOUR_PUBLIC_KEY',
  EMAILJS_SERVICE: (document.querySelector('meta[name="emailjs-service"]')?.content) || window.EMAILJS_SERVICE || window.__EMAILJS_SERVICE__ || 'YOUR_SERVICE_ID',
  EMAILJS_TEMPLATE:(document.querySelector('meta[name="emailjs-template"]')?.content) || window.EMAILJS_TEMPLATE || window.__EMAILJS_TEMPLATE__ || 'YOUR_TEMPLATE_ID'
};

/* ================== State ================== */
let participant = {};
let results = [];
let currentTrial = -1;
let sessionOrder = [];
let currentSessionIndex = 0;
let rightLevel = 0.5, leftLevel = 0.5;
let trialTimeout = null;
let isResponseAllowed = false; // Yeni değişken: Yanıta izin verilip verilmediğini kontrol eder

/* ================ Playlist (gömülü) ================ */
const playlist = [
  "LBA-RKA.wav","LDA-RGA.wav","LPA-RBA.wav","LKA-RDA.wav","LBA-RBA.wav",
  "LTA-RGA.wav","LBA-RDA.wav","LGA-RPA.wav","LDA-RKA.wav","LPA-RTA.wav",
  "LKA-RKA.wav","LBA-RGA.wav","LKA-RPA.wav","LTA-RDA.wav","LGA-RKA.wav",
  "LPA-RDA.wav","LGA-RGA.wav","LBA-RTA.wav","LGA-RDA.wav","LKA-RTA.wav",
  "LDA-RPA.wav","LTA-RKA.wav","LPA-RPA.wav","LDA-RBA.wav","LGA-RTA.wav",
  "LPA-RKA.wav","LTA-RBA.wav","LKA-RGA.wav","LTA-RTA.wav","LBA-RPA.wav",
  "LDA-RTA.wav","LGA-RBA.wav","LTA-RPA.wav","LDA-RDA.wav","LKA-RBA.wav",
  "LPA-RGA.wav"
];

/* ================ Helpers ================ */
function $id(i){ return document.getElementById(i); }
function log(msg){
  console.log(msg);
}
function showWarning(msg){
  alert(msg);
}

// Türkçe karakterleri İngilizce'ye çeviren yeni yardımcı fonksiyon
function trToEn(str) {
    return str
        .replace(/Ğ/g, 'G').replace(/ğ/g, 'g')
        .replace(/İ/g, 'I').replace(/ı/g, 'i')
        .replace(/Ş/g, 'S').replace(/ş/g, 's')
        .replace(/Ü/g, 'U').replace(/ü/g, 'u')
        .replace(/Ö/g, 'O').replace(/ö/g, 'o')
        .replace(/Ç/g, 'C').replace(/ç/g, 'c');
}

/* ================ Audio availability quick check =================== */
async function checkSampleFile(){
  try{
    const sample = 'silence.wav';
    const resp = await fetch('/sounds/'+sample, {method:'HEAD'});
    if(resp.ok){
      const ct = resp.headers.get('content-type')||'';
      if(!ct.includes('audio')) {
        log("Sunucu içerik tipi audio/ değil: "+ct+" — vercel.json ile Content-Type ayarı gerekebilir.");
      } else {
        log("Sunucu: ses dosyaları erişilebilir ("+sample+")");
      }
    } else {
      log("Sunucu /sounds/ klasöründen dosya okunamıyor (HTTP "+resp.status+"). Lütfen public/sounds dizinini ve vercel.json ayarlarını kontrol edin.");
    }
  }catch(e){
    log("Ses dosyası kontrolü sırasında hata: "+e.message);
  }
}

/* ================ Participant code + fields ======================== */
function makeParticipantCode(){
  const name = trToEn(($id('name').value || '').trim());
  const surname = trToEn(($id
