<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dikotik Dinleme Izmir</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:12px;color:#111;max-width:600px;margin-left:auto;margin-right:auto}
    h1{font-size:20px;margin-bottom:8px}
    .hidden{display:none}
    .card{padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:12px}
    input[type=text], input[type=number], select{padding:8px;margin:6px 0;width:100%;box-sizing:border-box}
    .respRow{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center}
    .respBtn{font-size:2rem;padding:18px 26px;margin:6px;min-width:120px;border-radius:10px;border:1px solid #444;background:#f2f2f2;cursor:pointer;transition:background-color 0.2s;}
    .respBtn-active{background-color:#bdbdbd}
    button{font-size:1.2rem;padding:14px 24px;width:100%;max-width:300px;border-radius:8px;border:1px solid #444;cursor:pointer;margin-top:6px}
    .small{font-size:13px;color:#666}
    .question-group{margin-bottom:12px}
  </style>
</head>
<body>
  <h1>Dikotik Dinleme Izmir</h1>

  <!-- Katılımcı Bilgileri -->
  <div id="participantCard" class="card">
    <h3>Katılımcı Bilgileri</h3>
    <input id="name" placeholder="Adınız">
    <input id="surname" placeholder="Soyadınız">
    <input id="age" type="number" placeholder="Yaşınız">
    <input id="race" placeholder="Irkınız / Doğum yeriniz (ülke)">
    <input id="motherTongue" placeholder="Anadiliniz">
    <select id="gender">
      <option value="">Cinsiyetinizi seçiniz</option>
      <option value="Kadın">Kadın</option>
      <option value="Erkek">Erkek</option>
      <option value="Diğer">Diğer</option>
    </select>
    <button id="toStaiBtn">Devam</button>
    <div id="codeInfo" class="small" style="margin-top:8px"></div>
  </div>

  <!-- STAI -->
  <div id="staiTxiCard" class="card hidden">
    <h3>STAI-TXI Formu</h3>
    <div class="small">Tüm soruları işaretlemeden devam edemezsiniz.</div>
    <div id="staiQuestions"></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
      <button id="backToParticipantBtn" style="flex:1;max-width:140px">Geri</button>
      <button id="toHandednessBtn" style="flex:1;max-width:140px">Devam</button>
    </div>
  </div>

  <!-- Hand use -->
  <div id="handUseCard" class="card hidden">
    <h3>El Kullanımı Testi</h3>
    <div class="small">Her işlem için en az bir kutucuk işaretlenmelidir.</div>
    <div id="handUseQuestions"></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
      <button id="backToStaiBtn" style="flex:1;max-width:140px">Geri</button>
      <button id="toHearingRightBtn" style="flex:1;max-width:140px">Devam</button>
    </div>
  </div>

  <!-- Hearing -->
  <div id="hearingRightCard" class="card hidden">
    <h3>İşitme Kontrolü</h3>
    <div id="rightEarControls">
      <strong>Sağ kulak (1500 Hz)</strong><br>
      <input type="range" id="rightSlider" min="0" max="1" step="0.01" value="0.5">
      <button id="playRight">Oynat / Durdur</button>
    </div>

    <div id="leftEarControls" class="hidden" style="margin-top:10px">
      <strong>Sol kulak (1500 Hz)</strong><br>
      <input type="range" id="leftSlider" min="0" max="1" step="0.01" value="0.5">
      <button id="playLeft">Oynat / Durdur</button>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
      <button id="backToHandednessBtn" style="flex:1;max-width:140px">Geri</button>
      <button id="confirmRightEarBtn" style="flex:1;max-width:140px">Sağ Kulağı Onayla</button>
      <button id="toSessionIntro" class="hidden" style="flex:1;max-width:140px">Devam</button>
    </div>
  </div>

  <!-- Session intro -->
  <div id="sessionIntro" class="card hidden">
    <h3 id="sessionTitle"></h3>
    <p id="sessionInstr"></p>
    <button id="sessionStartBtn">Devam</button>
  </div>

  <div id="waitScreen" class="card hidden">
    <h3>Test şimdi başlıyor...</h3>
    <div class="small">Test 10 saniye içinde başlayacak.</div>
  </div>

  <!-- Trial -->
  <div id="trialCard" class="card hidden">
    <div id="trialStatus" class="small" style="margin-bottom:8px"></div>
    <audio id="stimAudio" controls style="display:none" preload="auto"></audio>
    <div class="respRow">
      <button class="respBtn" data-val="BA">BA</button>
      <button class="respBtn" data-val="DA">DA</button>
      <button class="respBtn" data-val="GA">GA</button>
      <button class="respBtn" data-val="KA">KA</button>
      <button class="respBtn" data-val="PA">PA</button>
      <button class="respBtn" data-val="TA">TA</button>
    </div>
  </div>

  <!-- End -->
  <div id="endCard" class="card hidden">
    <h3>Deney tamamlandı ✅</h3>
    <button id="downloadBtn">CSV İndir</button>
    <div id="doneLog" class="small" style="margin-top:10px"></div>
  </div>

<script>
/* ---------- State ---------- */
const participant = {};
let results = [];
let currentTrial = -1;
let sessionOrder = [];
let currentSessionIndex = 0;
let rightLevel = 0.5, leftLevel = 0.5;
let trialTimeout = null;
let isResponseAllowed = false;

/* ---------- Playlists ---------- */
const mainPlaylist = [
  "LBA-RKA.wav","LDA-RGA.wav","LPA-RBA.wav","LKA-RDA.wav","LBA-RBA.wav"
];
const trainingPlaylist = [
  "LBA-RBA.wav","LDA-RDA.wav","LGA-RGA.wav"
];

/* ---------- Helpers ---------- */
function $id(id){ return document.getElementById(id); }
function trToEn(str){
  return (str||'').replace(/Ğ/g,'G').replace(/ğ/g,'g').replace(/İ/g,'I').replace(/ı/g,'i')
    .replace(/Ş/g,'S').replace(/ş/g,'s').replace(/Ü/g,'U').replace(/ü/g,'u')
    .replace(/Ö/g,'O').replace(/ö/g,'o').replace(/Ç/g,'C').replace(/ç/g,'c');
}
function shuffle(arr){ let a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }

/* ---------- Render forms ---------- */
const staiQuestions = [
 "Şu anda sakinim","Kendimi emniyette hissediyorum","Şu anda sinirlerim gergin",
 "Pişmanlık duygusu içindeyim","Şu anda huzur içindeyim","Şu anda hiç keyfim yok",
 "Başıma geleceklerden endişe ediyorum","Kendimi dinlenmiş hissediyorum","Şu anda kaygılıyım",
 "Kendimi rahat hissediyorum","Kendime güvenim var","Şu anda asabım bozuk",
 "Çok sinirliyim","Sinirlerimin çok gergin olduğunu hissediyorum","Kendimi rahatlamış hissediyorum",
 "Şu anda halimden memnunum","Şu anda endişeliyim","Heyecandan kendimi şaşkına dönmüş hissediyorum",
 "Şu anda sevinçliyim","Şu anda keyfim yerinde"
];
function renderStaiTxiForm(){
  const cont = $id('staiQuestions'); cont.innerHTML='';
  staiQuestions.forEach((q,i)=>{
    cont.innerHTML += `
      <div class="question-group">
        <p>${i+1}. ${q}</p>
        <label><input type="radio" name="staiQ${i+1}" value="1"> Hiç</label>
        <label><input type="radio" name="staiQ${i+1}" value="2"> Biraz</label>
        <label><input type="radio" name="staiQ${i+1}" value="3"> Çok</label>
        <label><input type="radio" name="staiQ${i+1}" value="4"> Tamamıyla</label>
      </div>
    `;
  });
}

const handUseQuestions = [
  "Yazmak","Çizmek","Taş Atmak","Makas kullanmak","Diş fırçası kullanmak",
  "Bıçak kullanmak","Kaşık kullanmak","Süpürge kullanmak (üst el)","Kibrit çakmak","Kutunun kapağını açmak"
];
function renderHandUseForm(){
  const cont = $id('handUseQuestions'); cont.innerHTML='';
  // header
  cont.innerHTML += `<div style="display:flex;justify-content:space-between;font-weight:600;margin-bottom:8px"><div style="flex:2"></div><div style="width:60px;text-align:center">Sol</div><div style="width:60px;text-align:center">Sağ</div></div>`;
  handUseQuestions.forEach((q,i)=>{
    const id = `handQ${i+1}`;
    cont.innerHTML += `
      <div class="question-group" data-question-id="${id}">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-top:1px solid #eee">
          <div style="flex:2">${i+1}. ${q}</div>
          <div style="flex:1;display:flex;justify-content:center;gap:8px">
            <input type="checkbox" class="left-option" name="${id}-sol-1">
            <input type="checkbox" class="left-option" name="${id}-sol-2">
          </div>
          <div style="flex:1;display:flex;justify-content:center;gap:8px">
            <input type="checkbox" class="right-option" name="${id}-sag-1">
            <input type="checkbox" class="right-option" name="${id}-sag-2">
          </div>
        </div>
      </div>
    `;
  });
}

/* ---------- Participant code & navigation ---------- */
function makeParticipantCode(){
  const name = trToEn($id('name').value||'').trim();
  const surname = trToEn($id('surname').value||'').trim();
  const age = ($id('age').value||'').trim();
  const race = ($id('race').value||'').trim();
  const motherTongue = ($id('motherTongue').value||'').trim();
  const gender = ($id('gender').value||'').trim();
  if(!name || !surname || !age || !race || !motherTongue || !gender){
    alert('Lütfen tüm katılımcı alanlarını doldurun.');
    return false;
  }
  participant.age = age; participant.gender = gender; participant.race = race; participant.motherTongue = motherTongue;
  const n2 = (name.padEnd(2).slice(0,2)).toUpperCase();
  const s2 = (surname.padEnd(2).slice(0,2)).toUpperCase();
  const four = (n2 + s2).replace(/[^A-Z]/g,'X').slice(0,4);
  const rand5 = Math.floor(10000 + Math.random()*90000);
  participant.code = `${four}_${rand5}`;
  $id('codeInfo').innerText = `Katılımcı kodu: ${participant.code} (yaş:${participant.age}, cinsiyet:${participant.gender})`;
  return true;
}

/* ---------- Event listeners: navigation ---------- */
$id('toStaiBtn').addEventListener('click',()=>{
  if(!makeParticipantCode()) return;
  $id('participantCard').classList.add('hidden');
  renderStaiTxiForm();
  $id('staiTxiCard').classList.remove('hidden');
});

$id('backToParticipantBtn').addEventListener('click',()=>{
  $id('staiTxiCard').classList.add('hidden');
  $id('participantCard').classList.remove('hidden');
});

$id('toHandednessBtn').addEventListener('click',()=>{
  // check all stai answered
  for(let i=1;i<=staiQuestions.length;i++){
    if(!document.querySelector(`input[name="staiQ${i}"]:checked`)){
      alert("Lütfen tüm STAI sorularını yanıtlayın.");
      return;
    }
  }
  // save
  const staiAnswers = {};
  document.querySelectorAll('#staiQuestions input[type="radio"]:checked').forEach(inp=> staiAnswers[inp.name]=inp.value);
  participant.staiAnswers = staiAnswers;
  // go forward
  $id('staiTxiCard').classList.add('hidden');
  renderHandUseForm();
  $id('handUseCard').classList.remove('hidden');
});

$id('backToStaiBtn').addEventListener('click',()=>{
  $id('handUseCard').classList.add('hidden');
  $id('staiTxiCard').classList.remove('hidden');
});

$id('toHearingRightBtn').addEventListener('click',()=>{
  const groups = document.querySelectorAll('#handUseQuestions .question-group');
  for(const g of groups){
    const checked = g.querySelectorAll('input[type="checkbox"]:checked').length;
    if(checked === 0){
      alert("Lütfen her işlem için en az bir kutucuk işaretleyin.");
      return;
    }
  }
  // save responses
  const handAnswers = {};
  groups.forEach(g=>{
    const id = g.dataset.questionId;
    handAnswers[id] = {
      left: g.querySelectorAll('.left-option:checked').length,
      right: g.querySelectorAll('.right-option:checked').length
    };
  });
  participant.handUseAnswers = handAnswers;
  $id('handUseCard').classList.add('hidden');
  $id('hearingRightCard').classList.remove('hidden');
});

/* ---------- Back from hearing ---------- */
$id('backToHandednessBtn').addEventListener('click',()=>{
  stopTone('right'); stopTone('left');
  $id('hearingRightCard').classList.add('hidden');
  $id('handUseCard').classList.remove('hidden');
});

/* ---------- 1500Hz tone via WebAudio ---------- */
let audioCtx = null, rightOsc=null, leftOsc=null, rightGain=null, leftGain=null;
function ensureAudioCtx(){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
function startTone(channel){
  ensureAudioCtx();
  if(channel==='right' && !rightOsc){
    rightOsc = audioCtx.createOscillator(); rightGain = audioCtx.createGain();
    rightOsc.type='sine'; rightOsc.frequency.value=1500; rightGain.gain.value=Number(rightLevel);
    const merger = audioCtx.createChannelMerger(2);
    rightOsc.connect(rightGain); rightGain.connect(merger,0,1); merger.connect(audioCtx.destination);
    rightOsc.start();
  }
  if(channel==='left' && !leftOsc){
    leftOsc = audioCtx.createOscillator(); leftGain = audioCtx.createGain();
    leftOsc.type='sine'; leftOsc.frequency.value=1500; leftGain.gain.value=Number(leftLevel);
    const merger = audioCtx.createChannelMerger(2);
    leftOsc.connect(leftGain); leftGain.connect(merger,0,0); merger.connect(audioCtx.destination);
    leftOsc.start();
  }
}
function stopTone(channel){
  try{
    if(channel==='right' && rightOsc){ rightOsc.stop(); rightOsc.disconnect(); rightOsc=null; rightGain=null; }
    if(channel==='left' && leftOsc){ leftOsc.stop(); leftOsc.disconnect(); leftOsc=null; leftGain=null; }
  }catch(e){}
}
$id('playRight').addEventListener('click', ()=> {
  if(rightOsc) { stopTone('right'); $id('playRight').innerText='Oynat / Durdur'; }
  else { startTone('right'); $id('playRight').innerText='Durdur'; }
});
$id('rightSlider').addEventListener('input', e=>{ rightLevel=e.target.value; if(rightGain) rightGain.gain.value=Number(rightLevel); });

$id('playLeft').addEventListener('click', ()=> {
  if(leftOsc) { stopTone('left'); $id('playLeft').innerText='Oynat / Durdur'; }
  else { startTone('left'); $id('playLeft').innerText='Durdur'; }
});
$id('leftSlider').addEventListener('input', e=>{ leftLevel=e.target.value; if(leftGain) leftGain.gain.value=Number(leftLevel); });

$id('confirmRightEarBtn').addEventListener('click', ()=>{
  stopTone('right');
  $id('rightSlider').disabled=true; $id('playRight').disabled=true;
  rightLevel = $id('rightSlider').value;
  leftLevel = rightLevel; $id('leftSlider').value = leftLevel;
  $id('leftEarControls').classList.remove('hidden');
  $id('confirmRightEarBtn').classList.add('hidden');
  $id('toSessionIntro').classList.remove('hidden');
});

$id('toSessionIntro').addEventListener('click', ()=>{
  stopTone('left');
  participant.hearing = { right:rightLevel, left:leftLevel };
  // push hearing as first info row in results (not necessary but handy)
  results.unshift({ session:'hearing', trial:0, stim:'1500Hz', response:`r=${rightLevel},l=${leftLevel}`, code:participant.code||'' });
  $id('hearingRightCard').classList.add('hidden');

  // prepare sessions: training + NF + FR/FL order randomized but alternate
  const second = Math.random()<0.5 ? 'FR' : 'FL';
  const third = (second==='FR') ? 'FL' : 'FR';
  sessionOrder = ['training','NF', second, third];
  currentSessionIndex = 0;
  showSessionIntro();
});

/* ---------- Session intro / start ---------- */
const instr = {
  training: "Eğitim oturumu. Dinleyin, yanıtlayabilirsiniz (cevaplar kayıt edilmez).",
  NF: "Her iki kulağınıza farklı heceler gelecek. En iyi duyduğunuz heceyi seçin.",
  FR: "Her iki kulağınıza farklı heceler gelecek. Sağ kulağa odaklanıp sağdan duyduğunuz heceyi seçin.",
  FL: "Her iki kulağınıza farklı heceler gelecek. Sol kulağa odaklanıp soldan duyduğunuz heceyi seçin."
};
function showSessionIntro(){
  const s = sessionOrder[currentSessionIndex];
  $id('sessionTitle').innerText = "Oturum: " + s;
  $id('sessionInstr').innerText = instr[s];
  $id('sessionIntro').classList.remove('hidden');
}

async function unlockAudioForPlayback(){
  try{
    const audioEl = $id('stimAudio');
    audioEl.muted = true;
    audioEl.src = "/sounds/erkek/" + (trainingPlaylist[0] || mainPlaylist[0]);
    await audioEl.play();
    audioEl.pause();
    audioEl.muted = false;
  }catch(e){ console.log("unlock audio:",e); }
}

$id('sessionStartBtn').addEventListener('click', async ()=>{
  $id('sessionIntro').classList.add('hidden');
  await unlockAudioForPlayback();
  $id('waitScreen').classList.remove('hidden');
  setTimeout(()=>{ $id('waitScreen').classList.add('hidden'); startSession(); }, 10000);
});

/* ---------- Session & trials ---------- */
function startSession(){
  currentTrial = -1;
  $id('trialCard').classList.remove('hidden');
  nextTrial();
}

async function playStim(stim, session){
  // allow responses in training too (but do not save)
  isResponseAllowed = true;
  const audioEl = $id('stimAudio');
  try{
    audioEl.src = "/sounds/erkek/" + stim;
    await audioEl.play();
    // set timeout depending on session
    const delay = (session==='training') ? 4000 : 5000;
    trialTimeout = setTimeout(()=>{
      if(session !== 'training'){
        // record no_response for non-training sessions
        results.push({ session: session, trial: currentTrial+1, stim: stim, response: 'no_response', code: participant.code||'', age: participant.age||'', gender: participant.gender||'' });
      }
      nextTrial();
    }, delay);
  }catch(e){ console.warn("playStim error", e); nextTrial(); }
}

function nextTrial(){
  currentTrial++;
  const playlist = (sessionOrder[currentSessionIndex] === 'training') ? trainingPlaylist : mainPlaylist;
  if(currentTrial >= playlist.length){
    // finish session
    $id('trialCard').classList.add('hidden');
    currentSessionIndex++;
    if(currentSessionIndex < sessionOrder.length){
      showSessionIntro();
    } else {
      endExperiment();
    }
    return;
  }
  const stim = playlist[currentTrial];
  $id('trialStatus').innerText = `Deneme ${currentTrial+1} / ${playlist.length} (${sessionOrder[currentSessionIndex]})`;
  playStim(stim, sessionOrder[currentSessionIndex]);
}

/* ---------- Response buttons ---------- */
document.querySelectorAll('.respBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    if(!isResponseAllowed){
      alert("Lütfen hecenin çalmasını bekleyiniz.");
      return;
    }
    if(trialTimeout){ clearTimeout(trialTimeout); trialTimeout=null; }
    const resp = btn.dataset.val;
    // choose correct playlist to find stim
    const playlist = (sessionOrder[currentSessionIndex] === 'training') ? trainingPlaylist : mainPlaylist;
    const stim = playlist[currentTrial];
    if(sessionOrder[currentSessionIndex] !== 'training'){
      results.push({ session: sessionOrder[currentSessionIndex], trial: currentTrial+1, stim: stim, response: resp, code: participant.code||'', age: participant.age||'', gender: participant.gender||'' });
    } else {
      console.log("Training response (not saved):", resp, stim);
    }
    isResponseAllowed = false;
    // small feedback
    btn.classList.add('respBtn-active');
    setTimeout(()=>btn.classList.remove('respBtn-active'), 700);
    setTimeout(()=>nextTrial(), 800);
  });
});

/* ---------- End and CSV ---------- */
function makeCsv(){
  // build combined header from participant info + stai/hand + results fields
  const info = {
    session: "info",
    trial: 0,
    code: participant.code||'',
    age: participant.age||'',
    gender: participant.gender||'',
    race: participant.race||'',
    motherTongue: participant.motherTongue||'',
    staiAnswers: participant.staiAnswers ? JSON.stringify(participant.staiAnswers) : '',
    handUseAnswers: participant.handUseAnswers ? JSON.stringify(participant.handUseAnswers) : ''
  };
  // ensure we can generate header keys (union)
  const combined = [info, ...results];
  const keysSet = new Set();
  combined.forEach(obj => Object.keys(obj).forEach(k=>keysSet.add(k)));
  const keys = Array.from(keysSet);
  const header = keys.join(',');
  const rows = combined.map(r => keys.map(k => {
    const v = r[k] === undefined || r[k] === null ? '' : String(r[k]).replace(/"/g,'""');
    return v.includes(',') ? `"${v}"` : v;
  }).join(','));
  return [header, ...rows].join('\n');
}

$id('downloadBtn').addEventListener('click', ()=>{
  const csv = makeCsv();
  if(!csv){ alert("Henüz veri yok."); return; }
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const now = new Date();
  const stamp = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}-${String(now.getMinutes()).padStart(2,'0')}`;
  const filename = `${participant.code||'participant'}_${stamp}.csv`;
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
  $id('doneLog').innerText = `CSV oluşturuldu: ${filename}`;
});

function endExperiment(){
  $id('endCard').classList.remove('hidden');
  console.log("Deney bitti. Toplam kayıt sayısı:", results.length);
}

/* ---------- On load checks ---------- */
window.addEventListener('load', ()=>{
  renderStaiTxiForm();
  renderHandUseForm();
});
</script>
</body>
</html>
