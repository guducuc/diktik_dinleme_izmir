<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dikotik Dinleme Izmir</title>

  <meta name="emailjs-user"    content="FLn2zMqKDGso3ePoO">
  <meta name="emailjs-service" content="service_a8bnfmk">
  <meta name="emailjs-template"content="template_7elc4wi">

  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:12px;color:#111;max-width:300px;margin:auto}
    h1{font-size:20px;margin-bottom:8px}
    .hidden{display:none}
    .card{padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:12px}
    input[type=text], input[type=number], select{padding:8px;margin:6px 0;width:100% ;box-sizing:border-box}
    .respRow{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center}
    .respBtn{
      font-size:2rem;
      padding:18px 26px;
      margin:6px;
      min-width:120px;
      border-radius:10px;
      border:1px solid #444;
      background:#f2f2f2;
      cursor:pointer;
      transition:background-color 0.2s;
    }
    .respBtn-active {
        background-color: #bdbdbd;
    }
    #warning{color:#8b0000;font-weight:600}
    .small{font-size:13px;color:#666}
    .question-group {margin-bottom: 12px;}
    .radio-label { display: block; margin-bottom: 4px; }
    button {
      font-size:1.2rem;
      padding:14px 24px;
      margin-top:10px;
      border-radius:8px;
      border:1px solid #444;
      background:#eee;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <h1>Dikotik Dinleme Izmir</h1>

  <div id="participantCard" class="card">
    <h3>Katılımcı Bilgileri</h3>
    <div><input id="name" placeholder="Adınız"></div>
    <div><input id="surname" placeholder="Soyadınız"></div>
    <div><input id="age" type="number" placeholder="Yaşınız"></div>
    <div><input id="race" placeholder="Irkınız/Doğum yeriniz (ülke)"></div>
    <div><input id="motherTongue" placeholder="Anadiliniz"></div>
    <div>
      <select id="gender">
        <option value="">Cinsiyetinizi seçiniz </option>
        <option value="Kadın">Kadın</option>
        <option value="Erkek">Erkek</option>
        <option value="Diğer">Diğer</option>
      </select>
    </div>
    <div style="margin-top:8px"><button id="toStaiBtn">Devam</button></div>
    <div id="codeInfo" class="small" style="margin-top:8px"></div>
  </div>

  <div id="staiTxiCard" class="card hidden">
    <h3>STAI-TXI Formu</h3>
    <div id="staiQuestions"></div>
    <div>
      <button id="backToParticipantBtn">Geri</button>
      <button id="toHandednessBtn">Devam</button>
    </div>
  </div>

  <div id="handUseCard" class="card hidden">
    <h3>El Kullanımı Testi</h3>
    <div id="handUseQuestions"></div>
    <div>
      <button id="backToStaiBtn">Geri</button>
      <button id="toHearingRightBtn">Devam</button>
    </div>
  </div>

  <div id="hearingRightCard" class="card hidden">
    <h3>İşitme Kontrolü</h3>
    <div>
      <div><strong>Sağ kulak (1500 Hz)</strong></div>
      <input type="range" id="rightSlider" min="0" max="1" step="0.01" value="0.5">
      <button id="playRight">Oynat / Durdur</button>
    </div>
    <div id="leftEarControls" class="hidden">
      <div><strong>Sol kulak (1500 Hz)</strong></div>
      <input type="range" id="leftSlider" min="0" max="1" step="0.01" value="0.5">
      <button id="playLeft">Oynat / Durdur</button>
    </div>
    <div>
      <button id="backToHandednessBtn">Geri</button>
      <button id="confirmRightEarBtn">Sağ Kulağı Onayla</button>
      <button id="toSessionIntro" class="hidden">Devam</button>
    </div>
  </div>

  <div id="sessionIntro" class="card hidden">
    <h3 id="sessionTitle"></h3>
    <p id="sessionInstr"></p>
    <button id="sessionStartBtn">Devam</button>
  </div>

  <div id="waitScreen" class="card hidden">
    <h3>Test şimdi başlıyor...</h3>
  </div>

  <div id="trialCard" class="card hidden">
    <div id="trialStatus" class="small"></div>
    <audio id="stimAudio" controls style="display:none" preload="auto"></audio>
    <div class="respRow">
      <button class="respBtn" data-val="BA">BA</button>
      <button class="respBtn" data-val="DA">DA</button>
      <button class="respBtn" data-val="GA">GA</button>
      <button class="respBtn" data-val="KA">KA</button>
      <button class="respBtn" data-val="PA">PA</button>
      <button class="respBtn" data-val="TA">TA</button>
    </div>
  </div>

  <div id="endCard" class="card hidden">
    <h3>Deney tamamlandı ✅</h3>
    <button id="downloadBtn">CSV İndir</button>
    <button id="emailBtn">E-posta Gönder</button>
    <div id="doneLog" class="small"></div>
  </div>

<script>
/* ================== State ================== */
let participant = {};
let results = [];
let currentTrial = -1;
let sessionOrder = [];
let currentSessionIndex = 0;
let rightLevel = 0.5, leftLevel = 0.5;
let trialTimeout = null;
let isResponseAllowed = false;

/* ================ Playlist ================= */
const mainPlaylist = [
  "LBA-RKA.wav","LDA-RGA.wav","LPA-RBA.wav","LKA-RDA.wav"
];
const trainingPlaylist = [
  "LBA-RBA.wav","LDA-RDA.wav","LGA-RGA.wav"
];

/* ================ Helpers ================ */
function $id(i){ return document.getElementById(i); }
function shuffle(array) {
  let currentIndex = array.length, randomIndex;
  while (currentIndex !== 0) {
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex--;
    [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
  }
  return array;
}

/* ================== Session ================== */
function startSession(){
  currentTrial = -1;
  $id('trialCard').classList.remove('hidden');
  nextTrial();
}

async function playStim(stim, session){
  isResponseAllowed = true;
  const audioEl = $id('stimAudio');
  try {
    audioEl.src = "/sounds/erkek/" + stim;
    await audioEl.play();
    trialTimeout = setTimeout(() => {
      if(session !== "training"){
        results.push({session:session, trial:currentTrial+1, stim:stim, response:"no_response", code:participant.code||""});
      }
      nextTrial();
    }, 5000);
  } catch(e){ console.error(e); }
}

function nextTrial(){
  currentTrial++;
  const playlist = (sessionOrder[currentSessionIndex]==="training") ? trainingPlaylist : mainPlaylist;
  if(currentTrial >= playlist.length){
    $id('trialCard').classList.add('hidden');
    currentSessionIndex++;
    if(currentSessionIndex < sessionOrder.length){
      showSessionIntro();
    } else {
      endExperiment();
    }
    return;
  }
  const stim = playlist[currentTrial];
  $id('trialStatus').innerText = "Deneme "+(currentTrial+1)+"/"+playlist.length;
  playStim(stim, sessionOrder[currentSessionIndex]);
}

document.querySelectorAll('.respBtn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    if(!isResponseAllowed) return;
    if(trialTimeout){clearTimeout(trialTimeout);trialTimeout=null;}
    const resp = btn.dataset.val;
    const stim = (sessionOrder[currentSessionIndex]==="training") ? trainingPlaylist[currentTrial] : mainPlaylist[currentTrial];
    if(sessionOrder[currentSessionIndex]!=="training"){
      results.push({session:sessionOrder[currentSessionIndex], trial:currentTrial+1, stim:stim, response:resp, code:participant.code||""});
    }
    nextTrial();
  });
});

/* ================== CSV ================== */
function makeCsv(){
  if(results.length===0) return null;
  const header = Object.keys(results[0]).join(",");
  const rows = results.map(r=>Object.values(r).join(","));
  return [header,...rows].join("\n");
}
$id('downloadBtn').addEventListener('click',()=>{
  const csv=makeCsv();
  if(!csv) return;
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download="results.csv";a.click();
  URL.revokeObjectURL(url);
});
function endExperiment(){
  $id('endCard').classList.remove('hidden');
}

/* ================== Session intro ================== */
const instr = {
  training:"Bu eğitim oturumudur.",
  NF:"Serbest yanıt.",
  FR:"Sağ kulağa odaklan.",
  FL:"Sol kulağa odaklan."
};
function showSessionIntro(){
  const s=sessionOrder[currentSessionIndex];
  $id('sessionTitle').innerText="Oturum: "+s;
  $id('sessionInstr').innerText=instr[s];
  $id('sessionIntro').classList.remove('hidden');
}
</script>
</body>
</html>
