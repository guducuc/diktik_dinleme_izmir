<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dikotik Dinleme Izmir</title>

  <meta name="emailjs-user"    content="FLn2zMqKDGso3ePoO">
  <meta name="emailjs-service" content="service_a8bnfmk">
  <meta name="emailjs-template"content="template_7elc4wi">

  <style>
    body {
      font-family: system-ui,Segoe UI,Roboto,Arial;
      margin: 12px;
      color: #111;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    h1 { font-size:20px; margin-bottom:8px }
    .hidden { display:none }
    .card {
      padding:12px; border:1px solid #ddd;
      border-radius:8px; margin-bottom:12px
    }
    input[type=text], input[type=number], select {
      padding:8px; margin:6px 0; width:100%;
      box-sizing:border-box
    }
    .respRow {
      display:flex; flex-wrap:wrap;
      gap:10px; align-items:center; justify-content:center;
    }
    .respBtn {
      font-size:2rem; padding:20px 30px;
      margin:6px; min-width:120px;
      border-radius:10px; border:1px solid #444;
      background:#f2f2f2; cursor:pointer;
      transition:background-color 0.2s;
    }
    .respBtn-active { background-color:#bdbdbd; }
    button {
      font-size:1.2rem;
      padding:14px 24px;
      width:100%;
      max-width:300px;
      border-radius:8px;
      border:1px solid #444;
      cursor:pointer;
      margin-top:6px;
    }
    #warning { color:#8b0000;font-weight:600 }
    .small { font-size:13px;color:#666 }
    .question-group { margin-bottom:12px; }
    .radio-label { display:block; margin-bottom:4px; }
  </style>
</head>
<body>
  <h1>Dikotik Dinleme Izmir</h1>

  <!-- Katılımcı Bilgileri -->
  <div id="participantCard" class="card">
    <h3>Katılımcı Bilgileri</h3>
    <div><input id="name" placeholder="Adınız"></div>
    <div><input id="surname" placeholder="Soyadınız"></div>
    <div><input id="age" type="number" placeholder="Yaşınız"></div>
    <div><input id="race" placeholder="Irkınız/Doğum yeriniz (ülke)"></div>
    <div><input id="motherTongue" placeholder="Anadiliniz"></div>
    <div>
      <select id="gender">
        <option value="">Cinsiyetinizi seçiniz </option>
        <option value="Kadın">Kadın</option>
        <option value="Erkek">Erkek</option>
        <option value="Diğer">Diğer</option>
      </select>
    </div>
    <button id="toStaiBtn">Devam</button>
    <div id="codeInfo" class="small" style="margin-top:8px"></div>
  </div>

  <!-- STAI Formu -->
  <div id="staiTxiCard" class="card hidden">
    <h3>STAI-TXI Formu</h3>
    <div id="staiQuestions"></div>
    <button id="backToParticipantBtn">Geri</button>
    <button id="toHandednessBtn">Devam</button>
  </div>

  <!-- El Kullanımı -->
  <div id="handUseCard" class="card hidden">
    <h3>El Kullanımı Testi</h3>
    <div id="handUseQuestions"></div>
    <button id="backToStaiBtn">Geri</button>
    <button id="toHearingRightBtn">Devam</button>
  </div>

  <!-- İşitme testi -->
  <div id="hearingRightCard" class="card hidden">
    <h3>İşitme Kontrolü</h3>
    <div id="rightEarControls">
      <strong>Sağ kulak (1500 Hz)</strong><br>
      <input type="range" id="rightSlider" min="0" max="1" step="0.01" value="0.5">
      <button id="playRight">Oynat / Durdur</button>
    </div>
    <div id="leftEarControls" class="hidden">
      <strong>Sol kulak (1500 Hz)</strong><br>
      <input type="range" id="leftSlider" min="0" max="1" step="0.01" value="0.5">
      <button id="playLeft">Oynat / Durdur</button>
    </div>
    <button id="backToHandednessBtn">Geri</button>
    <button id="confirmRightEarBtn">Sağ Kulağı Onayla</button>
    <button id="toSessionIntro" class="hidden">Devam</button>
  </div>

  <!-- Oturum giriş ekranı -->
  <div id="sessionIntro" class="card hidden">
    <h3 id="sessionTitle"></h3>
    <p id="sessionInstr"></p>
    <button id="sessionStartBtn">Devam</button>
  </div>

  <div id="waitScreen" class="card hidden">
    <h3>Test şimdi başlıyor...</h3>
  </div>

  <!-- Denemeler -->
  <div id="trialCard" class="card hidden">
    <div id="trialStatus" class="small"></div>
    <audio id="stimAudio" controls style="display:none" preload="auto"></audio>
    <div class="respRow">
      <button class="respBtn" data-val="BA">BA</button>
      <button class="respBtn" data-val="DA">DA</button>
      <button class="respBtn" data-val="GA">GA</button>
      <button class="respBtn" data-val="KA">KA</button>
      <button class="respBtn" data-val="PA">PA</button>
      <button class="respBtn" data-val="TA">TA</button>
    </div>
  </div>

  <!-- Bitiş -->
  <div id="endCard" class="card hidden">
    <h3>Deney tamamlandı ✅</h3>
    <button id="downloadBtn">CSV İndir</button>
    <button id="emailBtn">E-posta Gönder</button>
    <div id="doneLog" class="small"></div>
  </div>

<script>
/* === Önemli kısımlar: sadece farkları === */
const mainPlaylist = [
  "LBA-RKA.wav","LDA-RGA.wav","LPA-RBA.wav","LKA-RDA.wav","LBA-RBA.wav"
];
const trainingPlaylist = ["LBA-RBA.wav","LDA-RDA.wav"];

function playStim(stim, session){
  isResponseAllowed = true;
  const audioEl = document.getElementById('stimAudio');
  audioEl.src = "/sounds/erkek/" + stim;
  audioEl.play();
  trialTimeout = setTimeout(()=>nextTrial(), 5000);
}

document.querySelectorAll('.respBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    if(!isResponseAllowed) return;
    if(trialTimeout){clearTimeout(trialTimeout);}
    const resp = btn.dataset.val;
    const stim = (sessionOrder[currentSessionIndex]==="training")
        ? trainingPlaylist[currentTrial]
        : mainPlaylist[currentTrial];
    if(sessionOrder[currentSessionIndex]!=="training"){
      results.push({
        session: sessionOrder[currentSessionIndex],
        trial: currentTrial+1,
        stim: stim,
        response: resp,
        code: participant.code,
        age: participant.age,
        gender: participant.gender
      });
    }
    setTimeout(()=>nextTrial(), 2000);
  });
});

function makeCsv(){
  const combined = [];
  combined.push({
    session:"info",
    trial:0,
    ...participant,
    staiAnswers: JSON.stringify(participant.staiAnswers),
    handUseAnswers: JSON.stringify(participant.handUseAnswers)
  });
  combined.push(...results);
  const keys = Object.keys(combined[0]);
  const rows = combined.map(r=>keys.map(k=>r[k]||"").join(","));
  return [keys.join(","),...rows].join("\n");
}
</script>
</body>
</html>
