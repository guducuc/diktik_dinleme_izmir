<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dikotik Dinleme Izmir</title>

  <meta name="emailjs-user"    content="FLn2zMqKDGso3ePoO">
  <meta name="emailjs-service" content="service_a8bnfmk">
  <meta name="emailjs-template"content="template_7elc4wi">

  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:12px;color:#111}
    h1{font-size:20px;margin-bottom:8px}
    .hidden{display:none}
    .card{padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:12px}
    input[type=text], input[type=number], select{padding:8px;margin:6px 0;width:100% ;box-sizing:border-box}
    .respRow{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .respBtn{
      font-size:2rem;
      padding:18px 26px;
      margin:6px;
      min-width:120px;
      border-radius:10px;
      border:1px solid #444;
      background:#f2f2f2;
      cursor:pointer;
      transition:background-color 0.2s;
    }
    .respBtn-active {
        background-color: #bdbdbd; /* Buton basıldığında renk değişimi */
    }
    #warning{color:#8b0000;font-weight:600}
    .small{font-size:13px;color:#666}
    .question-group {margin-bottom: 12px;}
    .radio-label { display: block; margin-bottom: 4px; }
  </style>
</head>
<body>
  <h1>Dikotik Dinleme Izmir</h1>

  <div id="participantCard" class="card">
    <h3>Katılımcı Bilgileri</h3>
    <div><input id="name" placeholder="Ad"></div>
    <div><input id="surname" placeholder="Soyad"></div>
    <div><input id="age" type="number" placeholder="Yaş"></div>
    <div><input id="race" placeholder="Irk"></div>
    <div><input id="motherTongue" placeholder="Anadil"></div>
    <div>
      <select id="gender">
        <option value="">Cinsiyet seçin</option>
        <option value="Kadın">Kadın</option>
        <option value="Erkek">Erkek</option>
        <option value="Diğer">Diğer</option>
      </select>
    </div>
    <div style="margin-top:8px"><button id="toStaiBtn">Devam</button></div>
    <div id="codeInfo" class="small" style="margin-top:8px"></div>
  </div>

  <div id="staiTxiCard" class="card hidden">
    <h3>STAI-TXI Formu</h3>
    <p class="small">Aşağıda kişilerin kendilerine ait duygularını anlatmada kullandıkları bir takım ifadeler verilmiştir. Her ifadeyi okuyun, sonra da nasıl hissettiğinizi ifadelerin sağ tarafındaki seçeneklerden uygun olanını işaretlemek suretiyle belirtin. Doğru ya da yanlış cevap yoktur. Herhangi bir ifadenin üzerinde fazla zaman sarf etmeksizin anında nasıl hissettiğinizi gösteren cevabı işaretleyin.</p>
    
    <div id="staiQuestions"></div>

    <div style="margin-top:10px"><button id="toHandednessBtn">Devam</button></div>
  </div>

  <div id="handUseCard" class="card hidden">
    <h3>El Kullanımı Testi</h3>
    <p class="small">Sağ veya sol elinizi hangi işlemlerde kullandığınızı bilmek istiyoruz. Lütfen her işlemde kullandığınız ele göre ‘sol’ veya ‘sağ’ hanesini işaretleyin. Mesela yazı yazarken, genellikle sağ ama ara sıra sol elinizi kullanıyorsanız, her iki haneye bir X yapın. Daima sağ elinizi kullanıyorsanız, XX yazın. Diğer soruları aynı şekilde cevaplandırın.</p>
    <p class="small" style="margin-bottom: 10px;">Lütfen her işlem için bir veya iki kutu işaretleyin.</p>

    <div id="handUseQuestions"></div>

    <div style="margin-top:10px"><button id="toHearingRightBtn">Devam</button></div>
  </div>

  <div id="hearingRightCard" class="card hidden">
    <h3>İşitme Kontrolü (Sağ Kulak)</h3>
    <p class="small">Lütfen 1500 Hz tonunu sağ kulağınız için rahat duyabileceğiniz bir seviyeye ayarlayın. "Oynat" butonuna basarak sesi kontrol edin.</p>

    <div style="margin-top:8px">
      <div><strong>Sağ kulak (1500 Hz)</strong></div>
      <input type="range" id="rightSlider" min="0" max="1" step="0.01" value="0.5">
      <button id="playRight" style="margin-top:6px">Oynat / Durdur</button>
    </div>

    <div style="margin-top:12px">
      <button id="toHearingLeft">Devam</button>
    </div>
  </div>

  <div id="hearingLeftCard" class="card hidden">
    <h3>İşitme Kontrolü (Sol Kulak)</h3>
    <p class="small">Şimdi sol kulağınız için aynı işlemi yapın.</p>
    
    <div style="margin-top:8px">
      <div><strong>Sol kulak (1500 Hz)</strong></div>
      <input type="range" id="leftSlider" min="0" max="1" step="0.01" value="0.5">
      <button id="playLeft" style="margin-top:6px">Oynat / Durdur</button>
    </div>

    <div style="margin-top:12px">
      <button id="toSessionIntro">Devam</button>
    </div>
  </div>

  <div id="sessionIntro" class="card hidden">
    <h3 id="sessionTitle"></h3>
    <p id="sessionInstr"></p>
    <div style="margin-top:10px"><button id="sessionStartBtn">Devam</button></div>
  </div>

  <div id="waitScreen" class="card hidden">
    <h3>Test şimdi başlıyor...</h3>
    <p class="small">Lütfen kulaklıklarınızı yerinde tutun. Test 10 saniye sonra başlayacak.</p>
  </div>

  <div id="trialCard" class="card hidden">
    <div id="trialStatus" class="small" style="margin-bottom:8px"></div>
    <audio id="stimAudio" controls style="display:none" preload="auto"></audio>
    <div class="respRow">
      <button class="respBtn" data-val="BA">BA</button>
      <button class="respBtn" data-val="DA">DA</button>
      <button class="respBtn" data-val="GA">GA</button>
      <button class="respBtn" data-val="KA">KA</button>
      <button class="respBtn" data-val="PA">PA</button>
      <button class="respBtn" data-val="TA">TA</button>
    </div>
  </div>

  <div id="endCard" class="card hidden">
    <h3>Deney tamamlandı ✅</h3>
    <div style="margin-top:8px">
      <button id="downloadBtn">CSV İndir</button>
      <button id="emailBtn">E-posta Gönder</button>
    </div>
    <div id="doneLog" class="small" style="margin-top:8px"></div>
  </div>

<script>
/* ================== CONFIG (EmailJS: meta or global fallback) ================== */
const CONFIG = {
  EMAILJS_USER: (document.querySelector('meta[name="emailjs-user"]')?.content) || window.EMAILJS_USER || window.__EMAILJS_USER__ || 'YOUR_PUBLIC_KEY',
  EMAILJS_SERVICE: (document.querySelector('meta[name="emailjs-service"]')?.content) || window.EMAILJS_SERVICE || window.__EMAILJS_SERVICE__ || 'YOUR_SERVICE_ID',
  EMAILJS_TEMPLATE:(document.querySelector('meta[name="emailjs-template"]')?.content) || window.EMAILJS_TEMPLATE || window.__EMAILJS_TEMPLATE__ || 'YOUR_TEMPLATE_ID'
};

/* ================== State ================== */
let participant = {};
let results = [];
let currentTrial = -1;
let sessionOrder = [];
let currentSessionIndex = 0;
let rightLevel = 0.5, leftLevel = 0.5;
let trialTimeout = null;
let isResponseAllowed = false;

/* ================ Playlist (gömülü) ================ */
const mainPlaylist = [
  "LBA-RKA.wav","LDA-RGA.wav","LPA-RBA.wav","LKA-RDA.wav","LBA-RBA.wav",
  "LTA-RGA.wav","LBA-RDA.wav","LGA-RPA.wav","LDA-RKA.wav","LPA-RTA.wav",
  "LKA-RKA.wav","LBA-RGA.wav","LKA-RPA.wav","LTA-RDA.wav","LGA-RKA.wav",
  "LPA-RDA.wav","LGA-RGA.wav","LBA-RTA.wav","LGA-RDA.wav","LKA-RTA.wav",
  "LDA-RPA.wav","LTA-RKA.wav","LPA-RPA.wav","LDA-RBA.wav","LGA-RTA.wav",
  "LPA-RKA.wav","LTA-RBA.wav","LKA-RGA.wav","LTA-RTA.wav","LBA-RPA.wav",
  "LDA-RTA.wav","LGA-RBA.wav","LTA-RPA.wav","LDA-RDA.wav","LKA-RBA.wav",
  "LPA-RGA.wav"
];
const trainingPlaylist = [
  "LBA-RBA.wav", "LDA-RDA.wav", "LGA-RGA.wav", "LKA-RKA.wav", "LPA-RPA.wav", "LTA-RTA.wav",
  "LBA-RDA.wav", "LDA-RGA.wav", "LGA-RKA.wav", "LKA-RTA.wav", "LPA-RDA.wav", "LTA-RGA.wav",
  "LGA-RTA.wav"
];

/* ================ Helpers ================ */
function $id(i){ return document.getElementById(i); }
function showWarning(msg){
  alert(msg);
}

// Türkçe karakterleri İngilizce'ye çeviren yeni yardımcı fonksiyon
function trToEn(str) {
    return str
        .replace(/Ğ/g, 'G').replace(/ğ/g, 'g')
        .replace(/İ/g, 'I').replace(/ı/g, 'i')
        .replace(/Ş/g, 'S').replace(/ş/g, 's')
        .replace(/Ü/g, 'U').replace(/ü/g, 'u')
        .replace(/Ö/g, 'O').replace(/ö/g, 'o')
        .replace(/Ç/g, 'C').replace(/ç/g, 'c');
}

/* ================ Audio availability quick check =================== */
async function checkSampleFile(){
  try{
    const sample = 'silence.wav';
    const resp = await fetch('/sounds/'+sample, {method:'HEAD'});
    if(resp.ok){
      const ct = resp.headers.get('content-type')||'';
      if(!ct.includes('audio')) {
        console.log("Sunucu içerik tipi audio/ değil: "+ct+" — vercel.json ile Content-Type ayarı gerekebilir.");
      } else {
        console.log("Sunucu: ses dosyaları erişilebilir ("+sample+")");
      }
    } else {
      console.log("Sunucu /sounds/ klasöründen dosya okunamıyor (HTTP "+resp.status+"). Lütfen public/sounds dizinini ve vercel.json ayarlarını kontrol edin.");
    }
  }catch(e){
    console.log("Ses dosyası kontrolü sırasında hata: "+e.message);
  }
}

/* ================ Participant code + fields ======================== */
function makeParticipantCode(){
  const name = trToEn(($id('name').value || '').trim());
  const surname = trToEn(($id('surname').value || '').trim());
  const age = ($id('age').value || '').trim();
  const gender = ($id('gender').value || '').trim();
  const race = ($id('race').value || '').trim();
  const motherTongue = ($id('motherTongue').value || '').trim();
  
  if (!name || !surname || !age || !gender || !race || !motherTongue) {
      showWarning("Lütfen tüm zorunlu alanları (Ad, Soyad, Yaş, Cinsiyet, Irk, Anadil) doldurun.");
      return false;
  }

  participant.age = age;
  participant.gender = gender;
  participant.race = race;
  participant.motherTongue = motherTongue;
  
  const n2 = (name.padEnd(2).slice(0,2)).toUpperCase();
  const s2 = (surname.padEnd(2).slice(0,2)).toUpperCase();
  const four = (n2+s2).replace(/[^A-Z]/g,'X').slice(0,4);
  const rand5 = Math.floor(10000 + Math.random()*90000);
  const code = four + '_' + String(rand5);
  participant.code = code;
  $id('codeInfo').innerText = "Katılımcı kodu: " + code + "  (yaş: "+participant.age+", cinsiyet: "+participant.gender+", ırk: "+participant.race+", anadil: "+participant.motherTongue+")";
  console.log("Katılımcı kodu oluşturuldu: "+code);
  return true;
}

/* ================ WebAudio 1500Hz (kanal ayrımı) =================== */
let audioCtx = null;
let rightOsc = null, leftOsc = null, rightGain=null, leftGain=null;

function ensureAudioCtx(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}

function startTone(channel){
  ensureAudioCtx();
  if(channel==='right' && !rightOsc){
    rightOsc = audioCtx.createOscillator();
    rightGain = audioCtx.createGain();
    rightOsc.type = 'sine';
    rightOsc.frequency.value = 1500;
    rightGain.gain.value = Number(rightLevel);
    const merger = audioCtx.createChannelMerger(2);
    rightOsc.connect(rightGain);
    rightGain.connect(merger,0,1);
    merger.connect(audioCtx.destination);
    rightOsc.start();
  }
  if(channel==='left' && !leftOsc){
    leftOsc = audioCtx.createOscillator();
    leftGain = audioCtx.createGain();
    leftOsc.type = 'sine';
    leftOsc.frequency.value = 1500;
    leftGain.gain.value = Number(leftLevel);
    const merger = audioCtx.createChannelMerger(2);
    leftOsc.connect(leftGain);
    leftGain.connect(merger,0,0);
    merger.connect(audioCtx.destination);
    leftOsc.start();
  }
}
function stopTone(channel){
  try{
    if(channel==='right' && rightOsc){ rightOsc.stop(); rightOsc.disconnect(); rightOsc=null; rightGain=null; }
    if(channel==='left' && leftOsc){ leftOsc.stop(); leftOsc.disconnect(); leftOsc=null; leftGain=null; }
  }catch(e){ /*ignore*/ }
}

/* ================ UI bindings ===================================== */
$id('toStaiBtn').addEventListener('click', () => {
    if (!makeParticipantCode()) { return; }
    $id('participantCard').classList.add('hidden');
    $id('staiTxiCard').classList.remove('hidden');
    renderStaiTxiForm();
});
$id('toHandednessBtn').addEventListener('click', () => {
    let allAnswered = true;
    for (let i = 1; i <= staiQuestions.length; i++) {
        if (!document.querySelector(`input[name="staiQ${i}"]:checked`)) {
            allAnswered = false;
            break;
        }
    }
    if (!allAnswered) {
        alert("Lütfen tüm STAI sorularını yanıtlayın.");
        return;
    }

    // STAI yanıtlarını kaydet
    const staiAnswers = {};
    document.querySelectorAll('#staiQuestions input[type="radio"]:checked').forEach(input => {
        staiAnswers[input.name] = input.value;
    });
    participant.staiAnswers = staiAnswers;
    console.log("STAI yanıtları kaydedildi", staiAnswers);

    $id('staiTxiCard').classList.add('hidden');
    $id('handUseCard').classList.remove('hidden');
    renderHandUseForm();
});
    // STAI yanıtlarını kaydet
    const staiAnswers = {};
    document.querySelectorAll('#staiQuestions input[type="radio"]:checked').forEach(input => {
        staiAnswers[input.name] = input.value;
    });
    participant.staiAnswers = staiAnswers;
    console.log("STAI yanıtları kaydedildi", staiAnswers);

    $id('staiTxiCard').classList.add('hidden');
    $id('handUseCard').classList.remove('hidden');
    renderHandUseForm();
});
$id('toHearingRightBtn').addEventListener('click', () => {
    let allAnswered = true;
    document.querySelectorAll('#handUseQuestions .question-group').forEach(group => {
        const leftChecked = group.querySelector('.left-option').checked;
        const rightChecked = group.querySelector('.right-option').checked;
        if (!leftChecked && !rightChecked) {
            allAnswered = false;
        }
    });
    if (!allAnswered) {
        alert("Lütfen tüm el kullanımı sorularını yanıtlayın.");
        return;
    }

    // El kullanımı yanıtlarını kaydet
    const handUseAnswers = {};
    document.querySelectorAll('#handUseQuestions .question-group').forEach(group => {
        const questionId = group.dataset.questionId;
        const leftChecked = group.querySelector('.left-option').checked;
        const rightChecked = group.querySelector('.right-option').checked;
        if (leftChecked && rightChecked) {
            handUseAnswers[questionId] = 'both';
        } else if (leftChecked) {
            handUseAnswers[questionId] = 'left';
        } else if (rightChecked) {
            handUseAnswers[questionId] = 'right';
        }
    });
    participant.handUseAnswers = handUseAnswers;
    console.log("El kullanımı yanıtları kaydedildi", handUseAnswers);

    $id('handUseCard').classList.add('hidden');
    $id('hearingRightCard').classList.remove('hidden');
});
    // El kullanımı yanıtlarını kaydet
    const handUseAnswers = {};
    document.querySelectorAll('#handUseQuestions .question-group').forEach(group => {
        const questionId = group.dataset.questionId;
        const leftChecked = group.querySelector('.left-option').checked;
        const rightChecked = group.querySelector('.right-option').checked;
        if (leftChecked && rightChecked) {
            handUseAnswers[questionId] = 'both';
        } else if (leftChecked) {
            handUseAnswers[questionId] = 'left';
        } else if (rightChecked) {
            handUseAnswers[questionId] = 'right';
        } else {
            handUseAnswers[questionId] = 'no_response';
        }
    });
    participant.handUseAnswers = handUseAnswers;
    console.log("El kullanımı yanıtları kaydedildi", handUseAnswers);
    
    $id('handUseCard').classList.add('hidden');
    $id('hearingRightCard').classList.remove('hidden');
});

// Sağ kulak kontrolü
$id('playRight').addEventListener('click', ()=>{
  if(rightOsc) { stopTone('right'); $id('playRight').innerText='Oynat / Durdur'; }
  else { startTone('right'); $id('playRight').innerText='Durdur'; }
});
$id('rightSlider').addEventListener('input', e=>{ rightLevel = e.target.value; if(rightGain) rightGain.gain.value = Number(rightLevel); });

// Sağ kulaktan sol kulağa geçiş
$id('toHearingLeft').addEventListener('click', ()=>{
    stopTone('right'); // Sağ kulak tonunu durdur
    $id('hearingRightCard').classList.add('hidden');
    $id('hearingLeftCard').classList.remove('hidden');
});

// Sol kulak kontrolü
$id('playLeft').addEventListener('click', ()=>{
  if(leftOsc) { stopTone('left'); $id('playLeft').innerText='Oynat / Durdur'; }
  else { startTone('left'); $id('playLeft').innerText='Durdur'; }
});
$id('leftSlider').addEventListener('input', e=>{ leftLevel = e.target.value; if(leftGain) leftGain.gain.value = Number(leftLevel); });

// İşitme testinden oturum sayfasına geçiş
$id('toSessionIntro').addEventListener('click', ()=>{
  stopTone('left'); // Sol kulak tonunu durdur
  results.unshift({
    session:"hearing", trial:0, stim:"1500Hz",
    response:`right=${rightLevel},left=${leftLevel}`,
    rightLevel:rightLevel, leftLevel:leftLevel,
    age:participant.age, gender:participant.gender, code:participant.code || ''
  });
  console.log("İşitme bilgisi kaydedildi: sağ="+rightLevel+", sol="+leftLevel);

  $id('hearingLeftCard').classList.add('hidden');

  // Eğitim oturumunu ekle
  sessionOrder = ['training', 'NF', ...shuffle(['FR', 'FL'])];
  currentSessionIndex = 0;
  showSessionIntro();
});

function shuffle(array) {
  let currentIndex = array.length, randomIndex;
  while (currentIndex !== 0) {
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex--;
    [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
  }
  return array;
}

const instr = {
  training: "Birazdan dikotik dinleme eğitim oturumu başlayacak. Bu oturumda iki kulağınıza heceler çalınacak. Yanıt vermeniz gerekmiyor, sadece dinleyin.",
  NF: "Şimdi her iki kulağınıza farklı heceler gelecek. Lütfen en iyi duyduğunuz heceyi ilgili düğmeye basarak işaretleyiniz.",
  FR: "Şimdi her iki kulağınıza farklı heceler gelecek. Lütfen <b>sağ kulağınıza</b> odaklanın ve sağ kulağınızdan duyduğunuz heceyi işaretleyiniz.",
  FL: "Şimdi her iki kulağınıza farklı heceler gelecek. Lütfen <b>sol kulağınıza</b> odaklanın ve sol kulağınızdan duyduğunuz heceyi işaretleyiniz."
};

function showSessionIntro(){
  const s = sessionOrder[currentSessionIndex];
  $id('sessionTitle').innerText = "Oturum: " + s;
  $id('sessionInstr').innerHTML = instr[s];
  $id('sessionIntro').classList.remove('hidden');
}

/* ================ UNLOCK audio trick: must run inside click handler ================ */
async function unlockAudioForPlayback(){
  try{
    const audioEl = $id('stimAudio');
    audioEl.muted = true;
    audioEl.src = "/sounds/silence.wav";
    audioEl.load();
    await audioEl.play();
    audioEl.pause();
    audioEl.muted = false;
    console.log("Audio unlocked (tarayıcı izin verdi).");
  }catch(e){
    console.log("Audio unlock failed or not necessary: " + (e && e.message ? e.message : e));
  }
}

$id('sessionStartBtn').addEventListener('click', async (ev) => {
    $id('sessionIntro').classList.add('hidden');
    
    console.log("Ses çalma izni alınıyor...");
    await unlockAudioForPlayback();
    console.log("Ses çalma izni alındı. Test 10 saniye sonra başlayacak.");

    $id('waitScreen').classList.remove('hidden');

    setTimeout(() => {
        $id('waitScreen').classList.add('hidden');
        startSession();
    }, 10000);
});

/* ================ Session & trials ================================= */
function startSession(){
  currentTrial = -1;
  $id('trialCard').classList.remove('hidden');
  nextTrial();
}

async function playStim(stim, session){
  isResponseAllowed = (session !== 'training');
  const audioEl = $id('stimAudio');
  
  try {
    audioEl.src = "/sounds/silence.wav";
    await audioEl.play();
    console.log("Sessizlik dosyası çalındı.");

    audioEl.src = "/sounds/" + stim;
    await audioEl.play();
    console.log("Çalınıyor: " + stim + " (" + session + ")");
    
    const delay = (session === 'training') ? 4000 : 5000;

    trialTimeout = setTimeout(() => {
        console.log(delay/1000 + " saniye içinde yanıt verilmedi, sonraki heceye geçiliyor.");
        results.push({
            session: sessionOrder[currentSessionIndex],
            trial: currentTrial + 1,
            stim: stim,
            response: "no_response",
            rightLevel: "",
            leftLevel: "",
            age: participant.age || "",
            gender: participant.gender || "",
            race: participant.race || "",
            motherTongue: participant.motherTongue || "",
            code: participant.code || ""
        });
        nextTrial();
    }, delay);

  } catch (err) {
    console.warn("play err:", err);
    showWarning("Ses çalınamadı (tarayıcı izin/format/kaynak sorunları). Konsolu kontrol edin.");
  }
}

function nextTrial(){
  currentTrial++;
  const playlist = (sessionOrder[currentSessionIndex] === 'training') ? trainingPlaylist : mainPlaylist;
  if(currentTrial >= playlist.length){
    $id('trialCard').classList.add('hidden');
    currentSessionIndex++;
    if(currentSessionIndex < sessionOrder.length){
      showSessionIntro();
    } else {
      endExperiment();
    }
    return;
  }
  const stim = playlist[currentTrial];
  $id('trialStatus').innerText = "Deneme " + (currentTrial+1) + " / " + playlist.length + " (" + sessionOrder[currentSessionIndex] + ")";
  playStim(stim, sessionOrder[currentSessionIndex]);
}

/* cevap butonları */
document.querySelectorAll('.respBtn').forEach(btn => {
    btn.addEventListener('click', () => {
        if (!isResponseAllowed) {
            showWarning("Lütfen hecenin çalmasını bekleyiniz.");
            return;
        }

        if (trialTimeout) {
            clearTimeout(trialTimeout);
            trialTimeout = null;
        }

        const resp = btn.dataset.val;
        const stim = mainPlaylist[currentTrial];

        // Butona basıldığında aktif sınıfını ekle
        btn.classList.add('respBtn-active');

        // 1 saniye sonra rengi normale döndür
        setTimeout(() => {
            btn.classList.remove('respBtn-active');
        }, 1000);

        results.push({
            session: sessionOrder[currentSessionIndex],
            trial: currentTrial + 1,
            stim: stim,
            response: resp,
            rightLevel: "",
            leftLevel: "",
            age: participant.age || "",
            gender: participant.gender || "",
            race: participant.race || "",
            motherTongue: participant.motherTongue || "",
            code: participant.code || ""
        });
        console.log("Yanıt kaydedildi: " + resp + " (" + stim + ", " + sessionOrder[currentSessionIndex] + ")");

        setTimeout(() => {
            nextTrial();
        }, 4000);
    });
});

function endExperiment(){
  $id('endCard').classList.remove('hidden');
  console.log("Deney tamamlandı, toplam yanıt sayısı: "+results.length);
}

/* ================ CSV / filename / download ========================= */
function makeCsv() {
    if (results.length === 0) return null;
    let combinedResults = [];

    // Form yanıtlarını en başa ekle
    combinedResults.push({
        session: "info",
        trial: 0,
        ...participant,
        staiAnswers: JSON.stringify(participant.staiAnswers),
        handUseAnswers: JSON.stringify(participant.handUseAnswers)
    });

    combinedResults.push(...results);

    const keys = Object.keys(combinedResults[0]);
    const header = keys.join(',');

    const rows = combinedResults.map(r => {
        return keys.map(k => {
            const v = (r[k] === null || r[k] === undefined) ? "" : String(r[k]).replace(/\\r|\\n/g, ' ');
            if (v.includes(',')) return '"' + v.replace(/"/g, '""') + '"';
            return v;
        }).join(',');
    });

    return [header, ...rows].join('\\n');
}

$id('downloadBtn').addEventListener('click', ()=>{
  if(results.length === 0){ alert("Henüz sonuç yok"); return; }
  const csv = makeCsv();
  if(!csv) { alert("CSV oluşturulamadı"); return; }
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const now = new Date();
  const stamp = now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,"0") + "-" + String(now.getDate()).padStart(2,"0") + "_" + String(now.getHours()).padStart(2,"0") + "-" + String(now.getMinutes()).padStart(2,"0");
  const filename = (participant.code || "participant") + "_" + stamp + ".csv";
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
  console.log("CSV indirildi: " + filename);
});

/* ================ EmailJS sending (uses CONFIG above) ================ */
$id('emailBtn').addEventListener('click', async ()=>{
  if(results.length === 0){ alert("Henüz sonuç yok"); return; }
  const csv = makeCsv();
  if(!csv) return;

  const EMAILJS_USER = CONFIG.EMAILJS_USER;
  const EMAILJS_SERVICE = CONFIG.EMAILJS_SERVICE;
  const EMAILJS_TEMPLATE = CONFIG.EMAILJS_TEMPLATE;

  if(!EMAILJS_USER || EMAILJS_USER.startsWith('YOUR_')){ alert("EmailJS ayarlarını konfigüre edin (meta tag veya window var)."); return; }

  try{
    if(!window.emailjs){
      await new Promise((res,rej)=>{
        const s = document.createElement('script');
        s.src = "https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js";
        s.onload = res; s.onerror = rej;
        document.head.appendChild(s);
      });
    }
    emailjs.init(EMAILJS_USER);
    // NOT: Alıcı e-posta adresi, bu koddan geçirilmiyor.
    // Lütfen EmailJS panelinizde, bu şablonu (template_7elc4wi)
    // düzenleyerek "To" (Kime) alanını sabit bir e-posta adresiyle
    // doldurun. Bu sayede tüm sonuçlar belirlediğiniz adrese gönderilecektir.
    const templateParams = {
      subject: participant.code || "",
      message: csv
    };
    const resp = await emailjs.send(EMAILJS_SERVICE, EMAILJS_TEMPLATE, templateParams);
    $id('doneLog').innerText = "EmailJS cevabı: " + JSON.stringify(resp);
    console.log("E-posta gönderildi.");
  }catch(err){
    console.error("Email send err", err);
    alert("E-posta gönderilemedi: " + JSON.stringify(err));
    console.log("E-posta hatası: " + JSON.stringify(err));
  }
});

/* ================ Anket Formları Oluşturma ========================= */
const staiQuestions = [
    "Şu anda sakinim",
    "Kendimi emniyette hissediyorum",
    "Şu anda sinirlerim gergin",
    "Pişmanlık duygusu içindeyim",
    "Şu anda huzur içindeyim",
    "Şu anda hiç keyfim yok",
    "Başıma geleceklerden endişe ediyorum",
    "Kendimi dinlenmiş hissediyorum",
    "Şu anda kaygılıyım",
    "Kendimi rahat hissediyorum",
    "Kendime güvenim var",
    "Şu anda asabım bozuk",
    "Çok sinirliyim",
    "Sinirlerimin çok gergin olduğunu hissediyorum",
    "Kendimi rahatlamış hissediyorum",
    "Şu anda halimden memnunum",
    "Şu anda endişeliyim",
    "Heyecandan kendimi şaşkına dönmüş hissediyorum",
    "Şu anda sevinçliyim",
    "Şu anda keyfim yerinde"
];
function renderStaiTxiForm() {
    const container = $id('staiQuestions');
    container.innerHTML = '';
    staiQuestions.forEach((q, i) => {
        const questionHtml = `
            <div class="question-group">
                <p>${i + 1}. ${q}</p>
                <label><input type="radio" name="staiQ${i + 1}" value="1"> Hiç</label>
                <label><input type="radio" name="staiQ${i + 1}" value="2"> Biraz</label>
                <label><input type="radio" name="staiQ${i + 1}" value="3"> Çok</label>
                <label><input type="radio" name="staiQ${i + 1}" value="4"> Tamamıyla</label>
            </div>
        `;
        container.innerHTML += questionHtml;
    });
}

const handUseQuestions = [
    "Yazmak",
    "Çizmek",
    "Taş Atmak",
    "Makas kullanmak",
    "Diş fırçası kullanmak",
    "Bıçak kullanmak",
    "Kaşık kullanmak",
    "Süpürge kullanmak (üst el)",
    "Kibrit çakmak",
    "Kutunun kapağını açmak"
];
function renderHandUseForm() {
    const container = $id('handUseQuestions');
    container.innerHTML = '';
    const headerHtml = `
        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
            <div style="flex-grow:1;"></div>
            <div style="width: 50px; text-align: center;">Sol</div>
            <div style="width: 50px; text-align: center;">Sağ</div>
        </div>
    `;
    container.innerHTML += headerHtml;

    handUseQuestions.forEach((q, i) => {
        const questionId = `handQ${i + 1}`;
        const questionHtml = `
            <div class="question-group" data-question-id="${questionId}">
                <label style="display: flex; align-items: center; justify-content: space-between;">
                    <span style="flex-grow:1;">${i + 1}. ${q}</span>
                    <input type="checkbox" class="left-option" name="${questionId}-sol" value="sol" style="width: 50px;">
                    <input type="checkbox" class="right-option" name="${questionId}-sag" value="sag" style="width: 50px;">
                </label>
            </div>
        `;
        container.innerHTML += questionHtml;
    });
}


/* ================ Onload checks =================================== */
window.addEventListener('load', ()=>{
  checkSampleFile();
});
</script>
</body>
</html>
