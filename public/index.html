<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dikotik Dinleme Izmir</title>

  <meta name="emailjs-user"    content="FLn2zMqKDGso3ePoO">
  <meta name="emailjs-service" content="service_a8bnfmk">
  <meta name="emailjs-template"content="template_7elc4wi">

  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:12px;color:#111;max-width:700px;margin:auto}
    h1{text-align:center}
    .hidden{display:none}
    .card{padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:12px}
    input,select{padding:8px;margin:6px 0;width:100%;box-sizing:border-box}
    .respRow{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
    .respBtn{
      font-size:2rem;
      padding:20px 30px;
      margin:6px;
      min-width:120px;
      border-radius:10px;
      border:1px solid #444;
      background:#f2f2f2;
      cursor:pointer;
    }
    .respBtn-active{background:#bbb}
    button{
      font-size:1.2rem;
      padding:14px 24px;
      border-radius:8px;
      border:1px solid #444;
      background:#f8f8f8;
      cursor:pointer;
      width:100%;
      max-width:300px;
      margin:6px auto;
      display:block;
    }
    .small{font-size:13px;color:#666}
    .question-group{margin-bottom:12px}
    .hand-header{display:flex;justify-content:space-between;font-weight:600;margin-bottom:6px}
    .hand-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-top:1px solid #eee}
    .hand-row span{flex:2}
    .hand-col{flex:1;display:flex;justify-content:center;gap:10px}
  </style>
</head>
<body>
<h1>Dikotik Dinleme Izmir</h1>

<!-- Katılımcı -->
<div id="participantCard" class="card">
  <h3>Katılımcı Bilgileri</h3>
  <input id="name" placeholder="Adınız">
  <input id="surname" placeholder="Soyadınız">
  <input id="age" type="number" placeholder="Yaşınız">
  <input id="race" placeholder="Irkınız/Doğum yeriniz (ülke)">
  <input id="motherTongue" placeholder="Anadiliniz">
  <select id="gender">
    <option value="">Cinsiyet</option>
    <option>Kadın</option><option>Erkek</option><option>Diğer</option>
  </select>
  <button id="toStaiBtn">Devam</button>
  <div id="codeInfo" class="small"></div>
</div>

<!-- STAI -->
<div id="staiTxiCard" class="card hidden">
  <h3>STAI-TXI Formu</h3>
  <p class="small">Her ifadeyi okuyun ve şu anda nasıl hissettiğinizi en uygun seçeneği işaretleyerek belirtin.</p>
  <div id="staiQuestions"></div>
  <button id="backToParticipantBtn">Geri</button>
  <button id="toHandednessBtn">Devam</button>
</div>

<!-- El Kullanımı -->
<div id="handUseCard" class="card hidden">
  <h3>El Kullanımı Testi</h3>
  <div id="handUseQuestions"></div>
  <button id="backToStaiBtn">Geri</button>
  <button id="toHearingRightBtn">Devam</button>
</div>

<!-- İşitme -->
<div id="hearingRightCard" class="card hidden">
  <h3>İşitme Kontrolü</h3>
  <strong>Sağ kulak (1500 Hz)</strong>
  <input type="range" id="rightSlider" min="0" max="1" step="0.01" value="0.5">
  <button id="playRight">Oynat / Durdur</button>
  <div id="leftEarControls" class="hidden">
    <strong>Sol kulak (1500 Hz)</strong>
    <input type="range" id="leftSlider" min="0" max="1" step="0.01" value="0.5">
    <button id="playLeft">Oynat / Durdur</button>
  </div>
  <button id="confirmRightEarBtn">Sağ Kulağı Onayla</button>
  <button id="toSessionIntro" class="hidden">Devam</button>
</div>

<!-- Oturum intro -->
<div id="sessionIntro" class="card hidden">
  <h3 id="sessionTitle"></h3>
  <p id="sessionInstr"></p>
  <button id="sessionStartBtn">Devam</button>
</div>

<!-- Bekleme -->
<div id="waitScreen" class="card hidden">
  <h3>Test şimdi başlıyor...</h3>
  <p class="small">10 saniye içinde başlayacak.</p>
</div>

<!-- Trial -->
<div id="trialCard" class="card hidden">
  <div id="trialStatus" class="small"></div>
  <audio id="stimAudio" style="display:none"></audio>
  <div class="respRow">
    <button class="respBtn" data-val="BA">BA</button>
    <button class="respBtn" data-val="DA">DA</button>
    <button class="respBtn" data-val="GA">GA</button>
    <button class="respBtn" data-val="KA">KA</button>
    <button class="respBtn" data-val="PA">PA</button>
    <button class="respBtn" data-val="TA">TA</button>
  </div>
</div>

<!-- Son -->
<div id="endCard" class="card hidden">
  <h3>Deney tamamlandı ✅</h3>
  <button id="downloadBtn">CSV İndir</button>
  <button id="emailBtn">E-posta Gönder</button>
  <div id="doneLog" class="small"></div>
</div>

<script>
let participant={},results=[],currentTrial=-1,sessionOrder=[],currentSessionIndex=0;
let rightLevel=0.5,leftLevel=0.5,isResponseAllowed=false,trialTimeout=null;

// === Playlistler ===
const trainingPlaylist=["LBA-RBA.wav","LDA-RDA.wav","LGA-RGA.wav","LKA-RKA.wav","LPA-RPA.wav","LTA-RTA.wav","LBA-RDA.wav","LDA-RGA.wav","LGA-RKA.wav","LKA-RTA.wav"];
const mainPlaylist=["LBA-RKA.wav","LDA-RGA.wav","LPA-RBA.wav","LKA-RDA.wav","LBA-RBA.wav","LTA-RGA.wav","LBA-RDA.wav","LGA-RPA.wav","LDA-RKA.wav","LPA-RTA.wav","LKA-RKA.wav","LBA-RGA.wav","LKA-RPA.wav","LTA-RDA.wav","LGA-RKA.wav","LPA-RDA.wav","LGA-RGA.wav","LBA-RTA.wav","LGA-RDA.wav","LKA-RTA.wav","LDA-RPA.wav","LTA-RKA.wav","LPA-RPA.wav","LDA-RBA.wav","LGA-RTA.wav","LPA-RKA.wav","LTA-RBA.wav","LKA-RGA.wav","LTA-RTA.wav","LBA-RPA.wav","LDA-RTA.wav","LGA-RBA.wav","LTA-RPA.wav","LDA-RDA.wav","LKA-RBA.wav","LPA-RGA.wav"];

// === STAI soruları (20) ===
const staiQuestions=[
"Şu anda sakinim","Kendimi emniyette hissediyorum","Şu anda sinirlerim gergin","Pişmanlık duygusu içindeyim",
"Şu anda huzur içindeyim","Şu anda hiç keyfim yok","Başıma geleceklerden endişe ediyorum","Kendimi dinlenmiş hissediyorum",
"Şu anda kaygılıyım","Kendimi rahat hissediyorum","Kendime güvenim var","Şu anda asabım bozuk",
"Çok sinirliyim","Sinirlerimin çok gergin olduğunu hissediyorum","Kendimi rahatlamış hissediyorum","Şu anda halimden memnunum",
"Şu anda endişeliyim","Heyecandan kendimi şaşkına dönmüş hissediyorum","Şu anda sevinçliyim","Şu anda keyfim yerinde"
];

// === El kullanımı (10) ===
const handUseQuestions=["Yazmak","Çizmek","Taş atmak","Makas kullanmak","Diş fırçası kullanmak","Bıçak kullanmak","Kaşık kullanmak","Süpürge kullanmak (üst el)","Kibrit çakmak","Kutunun kapağını açmak"];

// === UI kısayol ===
function $id(x){return document.getElementById(x);}

// === Katılımcı kodu ===
$id('toStaiBtn').addEventListener('click',()=>{
  if(!$id('name').value||!$id('surname').value||!$id('age').value||!$id('gender').value||!$id('race').value||!$id('motherTongue').value){alert("Tüm bilgileri doldurun");return;}
  const n=$id('name').value.slice(0,2).toUpperCase();
  const s=$id('surname').value.slice(0,2).toUpperCase();
  participant.code=n+s+"_"+Math.floor(10000+Math.random()*90000);
  participant.age=$id('age').value;participant.gender=$id('gender').value;
  participant.race=$id('race').value;participant.motherTongue=$id('motherTongue').value;
  $id('participantCard').classList.add('hidden');$id('staiTxiCard').classList.remove('hidden');
  renderStaiTxiForm();
});

// === STAI formu ===
function renderStaiTxiForm(){
  const c=$id('staiQuestions');
  c.innerHTML='';
  staiQuestions.forEach((q,i)=>{
    c.innerHTML+=`
      <div class="question-group">
        <div><strong>${i+1}. ${q}</strong></div>
        <div style="display:flex;gap:20px;margin-top:4px;">
          <label><input type="radio" name="staiQ${i}" value="1"> Hiç</label>
          <label><input type="radio" name="staiQ${i}" value="2"> Biraz</label>
          <label><input type="radio" name="staiQ${i}" value="3"> Çok</label>
          <label><input type="radio" name="staiQ${i}" value="4"> Tamamıyla</label>
        </div>
      </div>`;
  });
}

$id('toHandednessBtn').addEventListener('click',()=>{
  const answered=document.querySelectorAll('#staiQuestions input:checked').length;
  if(answered<staiQuestions.length){alert("Tüm STAI sorularını yanıtlayın");return;}
  participant.staiAnswers={};document.querySelectorAll('#staiQuestions input:checked').forEach(x=>participant.staiAnswers[x.name]=x.value);
  $id('staiTxiCard').classList.add('hidden');$id('handUseCard').classList.remove('hidden');renderHandUseForm();
});

// === El kullanımı formu ===
function renderHandUseForm(){
  const c=$id('handUseQuestions');
  c.innerHTML=`<div class="hand-header"><div style="flex:2"></div><div style="flex:1;text-align:center">Sol</div><div style="flex:1;text-align:center">Sağ</div></div>`;
  handUseQuestions.forEach((q,i)=>{const id="handQ"+i;c.innerHTML+=`<div class="hand-row" data-question-id="${id}"><span>${i+1}. ${q}</span><div class="hand-col"><input type="checkbox" class="left-option"><input type="checkbox" class="left-option"></div><div class="hand-col"><input type="checkbox" class="right-option"><input type="checkbox" class="right-option"></div></div>`;});
}
$id('toHearingRightBtn').addEventListener('click',()=>{
  participant.handUseAnswers={};
  $id('handUseCard').classList.add('hidden');$id('hearingRightCard').classList.remove('hidden');
});

// === İşitme testi ===
$id('playRight').addEventListener('click',()=>{const a=new AudioContext();const o=a.createOscillator();const g=a.createGain();o.frequency.value=1500;g.gain.value=$id('rightSlider').value;o.connect(g).connect(a.destination);o.start();setTimeout(()=>o.stop(),1000);});
$id('playLeft').addEventListener('click',()=>{const a=new AudioContext();const o=a.createOscillator();const g=a.createGain();o.frequency.value=1500;g.gain.value=$id('leftSlider').value;o.connect(g).connect(a.destination);o.start();setTimeout(()=>o.stop(),1000);});
$id('confirmRightEarBtn').addEventListener('click',()=>{$id('leftEarControls').classList.remove('hidden');$id('confirmRightEarBtn').classList.add('hidden');$id('toSessionIntro').classList.remove('hidden');});
$id('toSessionIntro').addEventListener('click',()=>{$id('hearingRightCard').classList.add('hidden');sessionOrder=['training','NF',...shuffle(['FR','FL'])];currentSessionIndex=0;showSessionIntro();});

// === Session ===
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function showSessionIntro(){const s=sessionOrder[currentSessionIndex];$id('sessionTitle').innerText="Oturum: "+s;$id('sessionInstr').innerText="Yönerge";$id('sessionIntro').classList.remove('hidden');}
$id('sessionStartBtn').addEventListener('click',()=>{$id('sessionIntro').classList.add('hidden');$id('waitScreen').classList.remove('hidden');setTimeout(()=>{$id('waitScreen').classList.add('hidden');startSession();},10000);});

function startSession(){currentTrial=-1;$id('trialCard').classList.remove('hidden');nextTrial();}
async function playStim(stim,session){const a=$id('stimAudio');a.src="/sounds/erkek/"+stim;await a.play();isResponseAllowed=false;setTimeout(()=>{isResponseAllowed=true;},500);const delay=(session==="training")?4000:5000;trialTimeout=setTimeout(()=>{if(sessionOrder[currentSessionIndex]!=="training"){results.push({session:sessionOrder[currentSessionIndex],trial:currentTrial+1,stim:stim,response:"no_response",code:participant.code});}nextTrial();},delay);}
function nextTrial(){currentTrial++;const playlist=(sessionOrder[currentSessionIndex]==="training")?trainingPlaylist:mainPlaylist;if(currentTrial>=playlist.length){$id('trialCard').classList.add('hidden');currentSessionIndex++;if(currentSessionIndex<sessionOrder.length){showSessionIntro();}else{endExperiment();}return;}const stim=playlist[currentTrial];$id('trialStatus').innerText="Deneme "+(currentTrial+1)+"/"+playlist.length;playStim(stim,sessionOrder[currentSessionIndex]);}
document.querySelectorAll('.respBtn').forEach(btn=>btn.addEventListener('click',()=>{if(!isResponseAllowed){alert("Bekleyin");return;}if(trialTimeout){clearTimeout(trialTimeout);trialTimeout=null;}const resp=btn.dataset.val;const playlist=(sessionOrder[currentSessionIndex]==="training")?trainingPlaylist:mainPlaylist;const stim=playlist[currentTrial];if(sessionOrder[currentSessionIndex]!=="training"){results.push({session:sessionOrder[currentSessionIndex],trial:currentTrial+1,stim:stim,response:resp,code:participant.code});}btn.classList.add('respBtn-active');setTimeout(()=>btn.classList.remove('respBtn-active'),700);setTimeout(()=>nextTrial(),2000);}));
// === End & CSV ===
function endExperiment(){$id('endCard').classList.remove('hidden');}
function makeCsv(){const rows=[{...participant,stai:JSON.stringify(participant.staiAnswers),hand:JSON.stringify(participant.handUseAnswers)},...results];const keys=Object.keys(rows[0]);return[keys.join(','),...rows.map(r=>keys.map(k=>r[k]||'').join(','))].join('\n');}
$id('downloadBtn').addEventListener('click',()=>{const csv=makeCsv();const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=participant.code+".csv";a.click();URL.revokeObjectURL(url);});
$id('emailBtn').addEventListener('click',async()=>{const csv=makeCsv();if(!window.emailjs){await new Promise((res,rej)=>{const s=document.createElement('script');s.src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js";s.onload=res;s.onerror=rej;document.head.appendChild(s);});}emailjs.init("FLn2zMqKDGso3ePoO");await emailjs.send("service_a8bnfmk","template_7elc4wi",{subject:participant.code,message:csv});$id('doneLog').innerText="E-posta gönderildi.";});
</script>
</body>
</html>
